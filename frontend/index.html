<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lucky Wheel — Frontend</title>
    <style>
      :root {
        --size: 420px;
        --card: #121a33;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: radial-gradient(80% 80% at 50% 20%, #1b2a57, #0b1020);
        color: #e5e7eb;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }
      .wrap {
        width: min(94vw, 920px);
        padding: 24px;
        border-radius: 24px;
        background: var(--card);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45),
          inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      }
      h1 {
        margin: 0 0 8px;
        font-size: clamp(20px, 2.6vw, 28px);
      }
      .sub {
        margin: 0 0 22px;
        opacity: 0.75;
      }
      .stage {
        display: grid;
        gap: 18px;
        justify-items: center;
      }
      .wheel-box {
        position: relative;
        width: var(--size);
        height: var(--size);
        filter: drop-shadow(0 8px 25px rgba(0, 0, 0, 0.45));
      }
      canvas#wheel {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #0e1430;
        transition: transform 6s cubic-bezier(0.12, 0.02, 0.02, 1);
        will-change: transform;
      }
      .pointer {
        position: absolute;
        left: 50%;
        top: -10px;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 14px solid transparent;
        border-right: 14px solid transparent;
        border-bottom: 22px solid #fbbf24;
        filter: drop-shadow(0 2px 0 rgba(0, 0, 0, 0.35));
        z-index: 3;
      }
      .spin-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 120px;
        height: 120px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        pointer-events: auto;
      }
      .ui {
        display: grid;
        grid-auto-flow: column;
        gap: 12px;
        align-items: center;
      }
      button.spin {
        appearance: none;
        border: 0;
        padding: 12px 18px;
        border-radius: 999px;
        background: linear-gradient(180deg, #fbbf24, #f59e0b);
        color: #111827;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 6px 0 #b45309, inset 0 0 0 1px rgba(0, 0, 0, 0.12);
      }
      button.spin:not(.spin-center):active {
        transform: translateY(1px);
        box-shadow: 0 5px 0 #b45309, inset 0 0 0 1px rgba(0, 0, 0, 0.12);
      }
      button.spin.spin-center:active {
        transform: translate(-50%, -50%) translateY(1px);
        box-shadow: 0 5px 0 #b45309, inset 0 0 0 1px rgba(0, 0, 0, 0.12);
      }
      .result {
        min-height: 1.6em;
      }
      .legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 8px;
        margin-top: 12px;
        width: 100%;
      }
      .pill {
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .pill b {
        display: block;
      }

      /* LED ring (outer+inner), glow halo, dashed chase */
      .led-ring {
        position: absolute;
        inset: -10px;
        pointer-events: none;
        z-index: 1;
        transform-origin: 50% 50%;
      }
      .led {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        transform: translate(-50%, -50%) rotate(var(--angle))
          translate(var(--radius)) rotate(calc(-1 * var(--angle)));
        background: radial-gradient(
          circle at 50% 50%,
          #ffffff 0%,
          #ffe8a3 35%,
          #fbbf24 60%,
          rgba(0, 0, 0, 0) 72%
        );
        box-shadow: 0 0 6px #fbbf24, 0 0 16px rgba(251, 191, 36, 0.8);
        opacity: 0.85;
        filter: hue-rotate(var(--hue, 0deg));
        animation: ledPulse 1.2s linear infinite var(--delay),
          twinkle 5s linear infinite var(--tw);
      }
      .led--inner {
        width: 8px;
        height: 8px;
        box-shadow: 0 0 4px #93c5fd, 0 0 10px rgba(147, 197, 253, 0.9);
        filter: hue-rotate(calc(var(--hue, 0deg) + 40deg));
        opacity: 0.95;
      }
      @keyframes ledPulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }
      @keyframes twinkle {
        0%,
        96%,
        100% {
          opacity: inherit;
        }
        97%,
        99% {
          opacity: 0.6;
        }
      }
      @keyframes rotateRing {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes burst {
        0%,
        100% {
          box-shadow: 0 0 8px #fff, 0 0 16px rgba(255, 255, 255, 0.8);
        }
        50% {
          box-shadow: 0 0 20px #fff, 0 0 36px rgba(255, 255, 255, 1);
        }
      }
      .led-ring.spinning {
        animation: rotateRing 1s linear infinite;
      }
      .led-ring.spinning .led {
        animation-duration: 0.6s, 3s;
        box-shadow: 0 0 10px #ffd166, 0 0 26px rgba(255, 209, 102, 0.9);
      }
      .led-ring.celebrate .led {
        animation: burst 0.18s ease-in-out 6,
          twinkle 5s linear infinite var(--tw);
      }

      .glow-ring {
        position: absolute;
        inset: -18px;
        pointer-events: none;
        z-index: 0;
      }
      .glow-ring::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(251, 191, 36, 0.35),
          rgba(251, 191, 36, 0.18) 35%,
          transparent 70%
        );
        filter: blur(8px);
        opacity: 0.7;
        animation: neonPulse 2.2s ease-in-out infinite;
      }
      .glow-ring.spinning::before {
        animation-duration: 1s;
        opacity: 0.9;
      }
      .glow-ring.celebrate::before {
        animation: neonPulseFast 0.6s ease-in-out 6;
      }
      @keyframes neonPulse {
        0% {
          opacity: 0.6;
          transform: scale(0.985);
        }
        50% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0.6;
          transform: scale(0.985);
        }
      }
      @keyframes neonPulseFast {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }

      .dash-ring {
        position: absolute;
        inset: -6px;
        pointer-events: none;
        z-index: 2;
      }
      .dash-ring::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: conic-gradient(
          from 0deg,
          #fde68a 0 8deg,
          transparent 8deg 16deg
        );
        -webkit-mask: radial-gradient(
          circle at 50% 50%,
          transparent 74%,
          #000 74%
        );
        mask: radial-gradient(circle at 50% 50%, transparent 74%, #000 74%);
        opacity: 0.55;
        animation: dashRotate 2.8s linear infinite;
      }
      .dash-ring.spinning::before {
        animation-duration: 0.8s;
        opacity: 0.9;
      }
      .dash-ring.celebrate::before {
        animation: dashRotate 0.5s linear infinite;
      }
      @keyframes dashRotate {
        from {
          transform: rotate(0);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Voucher panel */
      .voucher {
        margin-top: 16px;
        width: 100%;
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 16px;
        align-items: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 14px;
      }
      .voucher .qr {
        width: 180px;
        height: 180px;
        border-radius: 12px;
        background: #0b1020;
        display: grid;
        place-items: center;
      }
      .voucher .meta b {
        font-size: 18px;
      }
      .copy {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.06);
        color: #e5e7eb;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Lucky Wheel</h1>
      <p class="sub">
        Weighted win rates + live quantities from CSV. After you win, you get a
        single-use voucher (code + QR) for store validation.
      </p>

      <div class="stage">
        <div class="wheel-box">
          <div class="glow-ring" aria-hidden="true"></div>
          <div class="led-ring" aria-hidden="true"></div>
          <div class="dash-ring" aria-hidden="true"></div>
          <div class="pointer"></div>
          <canvas id="wheel" width="840" height="840"></canvas>
          <button
            class="spin spin-center"
            id="spinBtn"
            type="button"
            aria-label="Spin the wheel"
          >
            Spin
          </button>
        </div>
        <div class="ui">
          <div class="result" id="result"></div>
        </div>
        <div class="legend" id="legend"></div>
        <div class="voucher" id="voucher" style="display: none">
          <div class="qr"><img id="voucherQR" alt="Voucher QR" /></div>
          <div class="meta">
            <div>
              <b id="voucherCode">—</b>
              <button class="copy" id="copyBtn" type="button">Copy</button>
            </div>
            <div>Expires: <span id="voucherExp">—</span></div>
            <div>Voucher ID: <span id="voucherId">—</span></div>
            <div style="opacity: 0.8; margin-top: 6px; font-size: 14px">
              Show this QR or give the code to the cashier to validate & redeem.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = ""; // same-origin on Vercel (calls /api/...)
      const wheel = document.getElementById("wheel");
      const ring = document.querySelector(".led-ring");
      const glow = document.querySelector(".glow-ring");
      const dash = document.querySelector(".dash-ring");
      const ctx = wheel.getContext("2d");
      const r = wheel.width / 2; // draw at 2x for crispness

      const palette = [
        "#60a5fa",
        "#34d399",
        "#f87171",
        "#fbbf24",
        "#a78bfa",
        "#22d3ee",
        "#f472b6",
        "#c4b5fd",
      ];

      // Build LED rings (outer + inner)
      function buildLEDs(outerCount = 48, innerCount = 48) {
        if (!ring) return;
        ring.innerHTML = "";
        const wheelSize = wheel.getBoundingClientRect().width;
        const outerR = wheelSize / 2 + 10; // just outside the wheel
        const innerR = wheelSize / 2 - 10; // hugging the rim
        const createStrip = (count, radius, isInner = false) => {
          for (let i = 0; i < count; i++) {
            const angle = (i / count) * 360;
            const el = document.createElement("span");
            el.className = "led" + (isInner ? " led--inner" : "");
            el.style.setProperty("--angle", angle + "deg");
            el.style.setProperty("--radius", radius + "px");
            el.style.setProperty("--delay", -i * 0.06 + "s");
            el.style.setProperty("--tw", (-Math.random() * 5).toFixed(2) + "s");
            el.style.setProperty(
              "--hue",
              (i * (360 / count)).toFixed(0) + "deg"
            );
            ring.appendChild(el);
          }
        };
        createStrip(outerCount, outerR, false);
        createStrip(innerCount, innerR, true);
      }
      window.addEventListener("resize", () => buildLEDs());
      document.addEventListener("DOMContentLoaded", () => {
        buildLEDs();
      });

      let GIFTS = []; // [{name, quantity, win_rate}]
      let N = 0;
      let absoluteRotationDeg = 0; // total rotation since start
      let spinning = false;

      const norm360 = (d) => ((d % 360) + 360) % 360; // [0, 360)

      async function fetchGifts() {
        const res = await fetch(`${API_BASE}/api/gifts`);
        if (!res.ok) throw new Error("Failed to load gifts");
        const data = await res.json();
        GIFTS = data.gifts || [];
        N = GIFTS.length;
      }

      function drawWheel() {
        if (N === 0) return;
        ctx.clearRect(0, 0, wheel.width, wheel.height);
        ctx.save();
        ctx.translate(r, r);
        const start = -Math.PI / 2; // -90° (top)
        const arc = (2 * Math.PI) / N;
        for (let i = 0; i < N; i++) {
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.fillStyle = palette[i % palette.length];
          ctx.arc(0, 0, r, start + i * arc, start + (i + 1) * arc);
          ctx.closePath();
          ctx.fill();
          ctx.save();
          const mid = start + (i + 0.5) * arc;
          ctx.rotate(mid);
          ctx.textAlign = "right";
          ctx.fillStyle = "#0b1020";
          ctx.font =
            "bold 30px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
          ctx.fillText(GIFTS[i].name, r - 24, 12);
          ctx.restore();
        }
        ctx.beginPath();
        ctx.arc(0, 0, 64, 0, 2 * Math.PI);
        ctx.fillStyle = "#111827";
        ctx.fill();
        ctx.restore();
      }

      function renderLegend() {
        const box = document.getElementById("legend");
        box.innerHTML = GIFTS.map(
          (g) => `
          <div class="pill">
            <b>${g.name}</b>
            <div>Left: ${g.quantity}</div>
            <div>Win rate: ${g.win_rate}</div>
          </div>
        `
        ).join("");
      }

      async function refresh() {
        await fetchGifts();
        drawWheel();
        renderLegend();
      }

      const resultEl = document.getElementById("result");
      const btn = document.getElementById("spinBtn");
      const voucherBox = document.getElementById("voucher");
      const voucherCodeEl = document.getElementById("voucherCode");
      const voucherExpEl = document.getElementById("voucherExp");
      const voucherIdEl = document.getElementById("voucherId");
      const voucherQREl = document.getElementById("voucherQR");
      const copyBtn = document.getElementById("copyBtn");

      copyBtn.addEventListener("click", async () => {
        const code = voucherCodeEl.textContent.trim();
        if (!code) return;
        try {
          await navigator.clipboard.writeText(code);
          copyBtn.textContent = "Copied!";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1200);
        } catch (e) {}
      });

      btn.addEventListener("click", async () => {
        if (N === 0) {
          resultEl.textContent = "No prizes configured.";
          return;
        }
        if (spinning) return;
        spinning = true;
        btn.disabled = true;
        resultEl.textContent = "";
        ring.classList.add("spinning");
        document.querySelector(".glow-ring")?.classList.add("spinning");
        document.querySelector(".dash-ring")?.classList.add("spinning");
        try {
          const res = await fetch(`${API_BASE}/api/spin`);
          if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || "Server error");
          }
          const data = await res.json();
          const index = data.index;

          // Align center of slice index at top pointer (-90°)
          const landingDeg = -(index + 0.5) * (360 / N);
          const currentMod = norm360(absoluteRotationDeg);
          let delta = norm360(landingDeg - currentMod);
          delta += 6 * 360; // forward full turns
          absoluteRotationDeg += delta;
          wheel.style.transform = `rotate(${absoluteRotationDeg}deg)`;

          setTimeout(async () => {
            // 1) announce
            resultEl.textContent = `You won: ${data.prize}! (left: ${data.remaining})`;
            ring.classList.remove("spinning");
            document.querySelector(".glow-ring")?.classList.remove("spinning");
            document.querySelector(".dash-ring")?.classList.remove("spinning");

            // 2) claim voucher
            const claimRes = await fetch(`${API_BASE}/api/claim`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                prize_index: index,
                prize_name: data.prize,
              }),
            });
            if (!claimRes.ok) throw new Error("Failed to issue voucher");
            const claim = await claimRes.json();

            // 3) show voucher
            voucherCodeEl.textContent = claim.code;
            const exp = new Date(claim.expires_at * 1000);
            voucherExpEl.textContent = exp.toLocaleString();
            voucherIdEl.textContent = claim.voucher_id;
            const qrData = encodeURIComponent(claim.qr_url);
            voucherQREl.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${qrData}`;
            voucherBox.style.display = "grid";

            spinning = false;
            btn.disabled = false;
            // Refresh quantities for the legend AFTER the spin animation
            await refresh();
          }, 6200);
        } catch (err) {
          resultEl.textContent = err.message;
          spinning = false;
          btn.disabled = false;
          ring.classList.remove("spinning");
          document.querySelector(".glow-ring")?.classList.remove("spinning");
          document.querySelector(".dash-ring")?.classList.remove("spinning");
        }
      });

      (async function init() {
        try {
          await refresh();
        } catch (err) {
          resultEl.textContent = err.message;
        }
      })();
    </script>
  </body>
</html>
